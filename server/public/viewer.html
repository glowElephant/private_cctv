<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CCTV Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    h1 { margin-bottom: 20px; color: #00d9ff; }
    #status {
      padding: 10px 20px;
      border-radius: 20px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    .connected { background: #00c853; }
    .disconnected { background: #ff5252; }
    .waiting { background: #ff9800; }
    #videoContainer {
      position: relative;
      width: 100%;
      max-width: 800px;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
    }
    #remoteVideo {
      width: 100%;
      height: auto;
      display: block;
    }
    #controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.1s;
    }
    button:hover { transform: scale(1.05); }
    button:active { transform: scale(0.95); }
    #connectBtn { background: #00d9ff; color: #000; }
    #micBtn { background: #4caf50; color: #fff; }
    #micBtn.muted { background: #ff5252; }
    #log {
      margin-top: 20px;
      width: 100%;
      max-width: 800px;
      background: #16213e;
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry { margin: 5px 0; color: #888; }
    .log-entry.info { color: #00d9ff; }
    .log-entry.error { color: #ff5252; }
  </style>
</head>
<body>
  <h1>CCTV Viewer</h1>
  <div id="status" class="disconnected">연결 안됨</div>

  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <div id="controls">
    <button id="connectBtn">연결</button>
    <button id="micBtn" class="muted">마이크 OFF</button>
  </div>

  <div id="log"></div>

  <script>
    const config = {
      token: 'view_secret_token_456'
    };

    let ws = null;
    let pc = null;
    let myId = null;
    let localStream = null;
    let micEnabled = false;

    const statusEl = document.getElementById('status');
    const videoEl = document.getElementById('remoteVideo');
    const connectBtn = document.getElementById('connectBtn');
    const micBtn = document.getElementById('micBtn');
    const logEl = document.getElementById('log');

    function log(msg, type = '') {
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function setStatus(text, className) {
      statusEl.textContent = text;
      statusEl.className = className;
    }

    async function connect() {
      if (ws) {
        ws.close();
        return;
      }

      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${location.host}?role=viewer&token=${config.token}`;

      log('서버 연결 중...', 'info');
      setStatus('연결 중...', 'waiting');

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        log('서버 연결됨', 'info');
        connectBtn.textContent = '연결 끊기';
      };

      ws.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        log(`수신: ${msg.type}`);

        switch (msg.type) {
          case 'your-id':
            myId = msg.id;
            log(`내 ID: ${myId}`, 'info');
            break;

          case 'camera-connected':
            log('카메라 온라인', 'info');
            setStatus('카메라 연결됨', 'connected');
            requestOffer();
            break;

          case 'camera-disconnected':
            log('카메라 오프라인', 'error');
            setStatus('카메라 오프라인', 'disconnected');
            if (pc) {
              pc.close();
              pc = null;
            }
            break;

          case 'offer':
            await handleOffer(msg);
            break;

          case 'ice-candidate':
            if (pc && msg.candidate) {
              await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            }
            break;
        }
      };

      ws.onclose = () => {
        log('서버 연결 종료', 'error');
        setStatus('연결 안됨', 'disconnected');
        ws = null;
        connectBtn.textContent = '연결';
        if (pc) {
          pc.close();
          pc = null;
        }
      };

      ws.onerror = (err) => {
        log('WebSocket 에러', 'error');
      };
    }

    function requestOffer() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'request-offer' }));
      }
    }

    async function handleOffer(msg) {
      log('Offer 수신, PeerConnection 생성', 'info');

      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      pc.ontrack = (event) => {
        log('비디오 트랙 수신', 'info');
        videoEl.srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate && ws) {
          ws.send(JSON.stringify({
            type: 'ice-candidate',
            candidate: event.candidate
          }));
        }
      };

      pc.onconnectionstatechange = () => {
        log(`연결 상태: ${pc.connectionState}`);
        if (pc.connectionState === 'connected') {
          setStatus('스트리밍 중', 'connected');
        }
      };

      // 마이크 트랙 추가 (양방향 음성용)
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getAudioTracks().forEach(track => {
          track.enabled = micEnabled;
          pc.addTrack(track, localStream);
        });
      } catch (e) {
        log('마이크 접근 불가: ' + e.message, 'error');
      }

      await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: 'answer',
        answer: answer
      }));
    }

    function toggleMic() {
      micEnabled = !micEnabled;
      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = micEnabled;
        });
      }
      micBtn.textContent = micEnabled ? '마이크 ON' : '마이크 OFF';
      micBtn.className = micEnabled ? '' : 'muted';
      log(`마이크 ${micEnabled ? '켜짐' : '꺼짐'}`, 'info');
    }

    connectBtn.onclick = connect;
    micBtn.onclick = toggleMic;

    log('CCTV 뷰어 준비됨', 'info');
  </script>
</body>
</html>
